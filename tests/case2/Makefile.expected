#!/usr/bin/make -f

SHELL = /bin/sh

srcdir = .

CC = gcc -O
YACC = bison -y
INSTALL = /usr/local/bin/install -c
INSTALLDATA = /usr/local/bin/install -c -m 644

DEFS = -DSIGTYPE=int -DDIRENT -DSTRSTR_MISSING \
       -DVPRINTF_MISSING -DBSD42

RTAPELIB = rtapelib.o
LIBS =
DEF_AR_FILE = /dev/rmt8
DEFBLOCKING = 20

CDEBUG = -g
CFLAGS = $(CDEBUG) -I. -I$(srcdir) $(DEFS) \
        -DDEF_AR_FILE=\"$(DEF_AR_FILE)\" \
        -DDEFBLOCKING=$(DEFBLOCKING)
LDFLAGS = -g

prefix = /usr/local

binprefix =

bindir = $(prefix)/bin

infodir = $(prefix)/info

SRCS_C  = tar.c create.c extract.c buffer.c   \
          getoldopt.c update.c gnu.c mangle.c \
          version.c list.c names.c diffarch.c \
          port.c wildmat.c getopt.c getopt1.c \
          regex.c
SRCS_Y  = getdate.y
SRCS    = $(SRCS_C) $(SRCS_Y)
OBJS    = $(SRCS_C:.c=.o) $(SRCS_Y:.y=.o) $(RTAPELIB)
AUX =   README COPYING ChangeLog Makefile.in  \
        makefile.pc configure configure.in \
        tar.texinfo tar.info* texinfo.tex \
        tar.h port.h open3.h getopt.h regex.h \
        rmt.h rmt.c rtapelib.c alloca.c \
        msd_dir.h msd_dir.c tcexparg.c \
        level-0 level-1 backup-specs testpad.c

.PHONY: all install
all: tar rmt tar.info
tar: $(OBJS)
tar:
	$(CC) $(LDFLAGS) -o $@ $(OBJS) $(LIBS)`
	
rmt: rmt.c
rmt:
	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ rmt.c
	
tar.info: tar.texinfo
tar.info:
	makeinfo tar.texinfo
	
install: all
install:
	$(INSTALL) tar $(bindir)/$(binprefix)tar
	-test ! -f rmt || $(INSTALL) rmt /etc/rmt
	$(INSTALLDATA) $(srcdir)/tar.info\* $(infodir)
	
$(OBJS): tar.h port.h testpad.h
$(OBJS):
	regex.o buffer.o tar.o: regex.h
	
testpad.h: testpad
testpad.h:
	./testpad
	
testpad: testpad.o
testpad:
	$(CC) -o $@ testpad.o
	
TAGS: $(SRCS)
TAGS:
	etags $(SRCS)
	
.PHONY: clean distclean realclean shar
clean:
	rm -f *.o tar rmt testpad testpad.h core
	
distclean: clean
distclean:
	rm -f TAGS Makefile config.status
	
realclean: distclean
realclean:
	rm -f tar.info*
	
shar: $(SRCS) $(AUX)
shar:
	shar $(SRCS) $(AUX) | compress \
	  > tar-`sed -e '/version_string/!d' \
	              -e 's/[^0-9.]*\([0-9.]*\).*/\1/' \
	              -e q
	              version.c`.shar.Z
	
dist: $(SRCS) $(AUX)
dist:
	echo tar-`sed \
	      -e '/version_string/!d' \
	      -e 's/[^0-9.]*\([0-9.]*\).*/\1/' \
	      -e q
	      version.c` > .fname
	-rm -rf `cat .fname`
	mkdir `cat .fname`
	ln $(SRCS) $(AUX) `cat .fname`
	tar chZf `cat .fname`.tar.Z `cat .fname`
	-rm -rf `cat .fname` .fname
	
tar.zoo: $(SRCS) $(AUX)
tar.zoo:
	-rm -rf tmp.dir
	-mkdir tmp.dir
	-rm tar.zoo
	for X in $(SRCS) $(AUX) ; do \
	    echo $$X ; \
	    sed 's/$$/^M/' $$X \
	    > tmp.dir/$$X ; done
	cd tmp.dir ; zoo aM ../tar.zoo *
	-rm -rf tmp.dir
	

# This makefile is generated by makedown from "EXAMPLE.md"
